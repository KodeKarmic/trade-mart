flowchart LR
 subgraph CLIENTS["ğŸ‘¥ Client Sources"]
        C1["Client A â€“ REST/FIX"]
        C2["Client B â€“ Batch Upload"]
        C3["Client C â€“ Streaming Feed"]
  end
 subgraph INGESTION["ğŸ§­ Ingestion Layer"]
        GW["API Gateway â€“ Auth, Rate Limit, Routing"]
        INJ["Ingestion Service â€“ Schema Validation & Normalization"]
  end
 subgraph PIPELINE["ğŸŒ€ Kafka Streaming Layer"]
        RAW["<b>â˜• Kafka Topic:</b> trades-raw"]
        VALID["<b>â˜• Kafka Topic:</b> valid-trades"]
        REJ["<b>â˜• Kafka Topic:</b> rejections"]
        EXP["<b>â˜• Kafka Topic:</b> expiry-events"]
        REPAIR["<b>â˜• Kafka Topic:</b> repair-commands"]
  end
 subgraph PROCESSING["âš™ï¸ Stream Processing"]
        SP["Stream Processor â€“ Version Gating, Enrichment, Expiry Detection"]
  end
 subgraph DATABASES["ğŸ’¾ Persistence Layer"]
        PG["<b>ğŸ˜ PostgreSQL</b><br>Authoritative Store"]
        MONGO["<b>ğŸƒ MongoDB</b><br>Serving Store for Scalable Reads"]
  end
 subgraph QUERY["ğŸ” Query & Analytics"]
        APIQ["Trade Query API â€“ Read from MongoDB or PostgreSQL"]
        BI["BI / Analytics â€“ Read from PostgreSQL"]
  end
 subgraph OPS["ğŸ› ï¸ Ops & Repair"]
        REPAIR_UI["Repair Console â€“ Human Review Interface"]
        REPAIR_SVC["Repair Service â€“ Emits Repair Commands"]
  end
 subgraph EVENTS["ğŸ“¡ System Events / Outputs"]
        OUT_VALID["âœ… Valid Trades â€“ Accepted, Latest Versions Only"]
        OUT_REJ["âŒ Rejected Trades â€“ Older Versions or Invalid Schema"]
        OUT_EXP["â³ Expired Trades â€“ Maturity or Cancellation"]
        OUT_REPAIR["ğŸ”§ Repair Events â€“ Manual or Automated Fix"]
  end
 subgraph OBSERVABILITY["ğŸ“ˆ Observability & Scaling"]
        MET["Metrics & Tracing â€“ Prometheus, Grafana, OpenTelemetry"]
        K8S["Kubernetes HPA â€“ Autoscale on CPU, Kafka Lag, DB Latency"]
  end
    C1 --> GW
    C2 --> GW
    C3 --> GW
    GW --> INJ
    INJ --> RAW
    RAW --> SP
    SP --> VALID & REJ & EXP & MET
    VALID --> WRPG["Postgres Writer â€“ Upsert (Version Check)"] & WRMG["Mongo Writer â€“ Denormalized Views"] & OUT_VALID
    WRPG --> PG & MET
    WRMG --> MONGO & MET
    EXP --> WRPG & WRMG & OUT_EXP
    APIQ --> PG & MONGO
    BI --> PG
    REPAIR_UI --> REPAIR_SVC
    REPAIR_SVC --> REPAIR
    REPAIR --> SP & OUT_REPAIR
    REJ --> OUT_REJ
    MET --> K8S

     C1:::rounded
     C2:::rounded
     C3:::rounded
     GW:::rounded
     INJ:::rounded
     RAW:::rounded
     VALID:::rounded
     REJ:::rounded
     EXP:::rounded
     REPAIR:::rounded
     SP:::rounded
     PG:::rounded
     MONGO:::rounded
     APIQ:::rounded
     BI:::rounded
     REPAIR_UI:::rounded
     REPAIR_SVC:::rounded
     OUT_VALID:::rounded
     OUT_REJ:::rounded
     OUT_EXP:::rounded
     OUT_REPAIR:::rounded
     MET:::rounded
     K8S:::rounded
     WRPG:::rounded
     WRMG:::rounded
    classDef rounded stroke:#333,stroke-width:1px,rx:10,ry:10,fill:#f9f9f9


